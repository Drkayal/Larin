import asyncio
import os
import shutil
import socket
from datetime import datetime

import urllib3
from git import Repo
from git.exc import GitCommandError, InvalidGitRepositoryError
from pyrogram import filters

import config
from ZeMusic import app
from ZeMusic.misc import HAPP, SUDOERS, XCB
from ZeMusic.utils.database import (
    get_active_chats,
    remove_active_chat,
    remove_active_video_chat,
)
from ZeMusic.utils.decorators.language import language
from ZeMusic.utils.pastebin import ModyBin

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


async def save_bot_settings():
    """Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„"""
    try:
        if config.DATABASE_TYPE == "postgresql":
            from ZeMusic.database.dal import user_dal, chat_settings_dal, auth_dal
            
            # Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
            # Ù‡Ø°Ø§ ÙŠØªÙ… Ø¨Ø´ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø¨Ø± DAL
            
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†
            from ZeMusic.misc import SUDOERS
            for sudo_id in SUDOERS:
                if sudo_id not in [config.OWNER_ID, config.DAV]:
                    await auth_dal.add_sudo(sudo_id)
            
            return True
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: {e}")
        return False
    
    return True  # MongoDB ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹


async def is_heroku():
    return "heroku" in socket.getfqdn()


@app.on_message(filters.command(["getlog", "logs", "Ø§Ù„Ø³Ø¬Ù„Ø§Øª"]) & SUDOERS)
@language
async def log_(client, message, _):
    try:
        await message.reply_document(document="log.txt")
    except:
        await message.reply_text(_["server_1"])


@app.on_message(filters.command(["update", "ØªØ­Ø¯ÙŠØ«"]) & SUDOERS)
@language
async def update_(client, message, _):
    if await is_heroku():
        if HAPP is None:
            return await message.reply_text(_["server_2"])
    response = await message.reply_text(_["server_3"])
    try:
        repo = Repo()
    except GitCommandError:
        return await response.edit(_["server_4"])
    except InvalidGitRepositoryError:
        return await response.edit(_["server_5"])
    to_exc = f"git fetch origin {config.UPSTREAM_BRANCH} &> /dev/null"
    os.system(to_exc)
    await asyncio.sleep(7)
    verification = ""
    REPO_ = repo.remotes.origin.url.split(".git")[0]
    for checks in repo.iter_commits(f"HEAD..origin/{config.UPSTREAM_BRANCH}"):
        verification = str(checks.count())
    if verification == "":
        return await response.edit(_["server_6"])
    updates = ""
    ordinal = lambda format: "%d%s" % (
        format,
        "tsnrhtdd"[(format // 10 % 10 != 1) * (format % 10 < 4) * format % 10 :: 4],
    )
    for info in repo.iter_commits(f"HEAD..origin/{config.UPSTREAM_BRANCH}"):
        updates += f"<b>â‡’ #{info.count()}: <a href={REPO_}/commit/{info}>{info.summary}</a> Ê™Ê -> {info.author}</b>\n\t\t\t\t<b>â¥ á´„á´á´á´Éªá´›á´‡á´… á´É´ :</b> {ordinal(int(datetime.fromtimestamp(info.committed_date).strftime('%d')))} {datetime.fromtimestamp(info.committed_date).strftime('%b')}, {datetime.fromtimestamp(info.committed_date).strftime('%Y')}\n\n"
    _update_response_ = "<b<b>ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­ Ù„Ù„Ø¨ÙˆØª!</b>\n\nâ‡ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¢Ù†\n\n<b><u>Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:</u></b>\n\n"
    _final_updates_ = _update_response_ + updates
    if len(_final_updates_) > 4096:
        url = await ModyBin(updates)
        nrs = await response.edit(
            f"<b>ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨ÙˆØª !</b>\n\nâ‡ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø§Ù†\n\n<u><b>Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª :</b></u>\n\n<a href={url}>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</a>"
        )
    else:
        nrs = await response.edit(_final_updates_, disable_web_page_preview=True)
    os.system("git stash &> /dev/null && git pull")

    # Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    save_status = await save_bot_settings()
    if save_status:
        await response.edit(f"{nrs.text}\n\nâœ… **ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­**")
    
    try:
        served_chats = await get_active_chats()
        for x in served_chats:
            try:
                await app.send_message(
                    chat_id=int(x),
                    text=_["server_8"].format(app.mention),
                )
                await remove_active_chat(x)
                await remove_active_video_chat(x)
            except:
                pass
        await response.edit(f"{nrs.text}\n\n{_['server_7']}")
    except:
        pass

    if await is_heroku():
        try:
            os.system(
                f"{XCB[5]} {XCB[7]} {XCB[9]}{XCB[4]}{XCB[0]*2}{XCB[6]}{XCB[4]}{XCB[8]}{XCB[1]}{XCB[5]}{XCB[2]}{XCB[6]}{XCB[2]}{XCB[3]}{XCB[0]}{XCB[10]}{XCB[2]}{XCB[5]} {XCB[11]}{XCB[4]}{XCB[12]}"
            )
            return
        except Exception as err:
            await response.edit(f"{nrs.text}\n\n{_['server_9']}")
            return await app.send_message(
                chat_id=config.LOGGER_ID,
                text=_["server_10"].format(err),
            )
    else:
        os.system("pip3 install -r requirements.txt")
        os.system(f"kill -9 {os.getpid()} && bash start")
        exit()


@app.on_message(filters.command(["restart", "Ø§Ø¹Ø§Ø¯Ù‡ ØªØ´ØºÙŠÙ„", "Ø¥Ø¹Ø§Ø¯Ù‡ ØªØ´ØºÙŠÙ„" ,"Ø§Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„", "Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„"]) & SUDOERS)
async def restart_(_, message):
    response = await message.reply_text("ğŸ”„ **Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„...**")
    
    # Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    save_status = await save_bot_settings()
    if save_status:
        await response.edit_text("âœ… **ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­**\nğŸ”„ **Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„...**")
    else:
        await response.edit_text("âš ï¸ **ØªØ­Ø°ÙŠØ±: Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª**\nğŸ”„ **Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„...**")
    
    ac_chats = await get_active_chats()
    #for x in ac_chats:
        #try:
            #await app.send_message(
                #chat_id=int(x),
                #text=f"<b>â‡ Ø¬Ø§Ø±ÙŠ Ø§Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„:</b> {app.mention} ...\n\n<b>â‡ Ø³ÙŠØªÙ… Ø§Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙˆØª Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¹Ø¯ Ù…Ø±ÙˆØ± 5 Ø¯Ù‚Ø§Ø¦Ù‚.</b>",
            #)
            #await remove_active_chat(x)
            #await remove_active_video_chat(x)
        #except:
            #pass

    try:
        shutil.rmtree("downloads")
        shutil.rmtree("raw_files")
        shutil.rmtree("cache")
    except:
        pass
    await response.edit_text("á¯“ âŒ¯ ğš‚ğ™¾ğš„ğšğ™²ğ™´ ğ™ºğ™¸ğ™½ğ™¶ ğŸ¢ Ø¥Ø¹Ù€Ù€Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ€Ù€Ù„\nâ€¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€¢\n\nâ€¢â†â”ŠÙŠØªÙ€Ù… Ø§Ù„Ø§Ù† Ø§Ø¹Ù€Ø§Ø¯Ø© ØªØ´ØºÙŠÙ€Ù„ Ø¨Ù€ÙˆØª Ù…ÙŠÙˆØ²Ùƒ\nâ€¢â†â”ŠÙ‚Ù€Ø¯ ÙŠØ³ØªØºÙ€Ø±Ù‚ Ø§Ù„Ø§Ù…Ù€Ø± 3-5 Ø¯Ù‚Ø§Ø¦Ù€Ù‚...")
    os.system(f"kill -9 {os.getpid()} && bash start")


@app.on_message(filters.command(["savesettings", "Ø­ÙØ¸_Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", "backup_settings"]) & SUDOERS)
@language
async def save_settings_command(client, message, _):
    """Ø£Ù…Ø± Ù„Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ÙŠØ¯ÙˆÙŠØ§Ù‹"""
    status_msg = await message.reply_text("ğŸ”„ **Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª...**")
    
    try:
        # Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        save_status = await save_bot_settings()
        
        if save_status:
            # Ø¬Ù…Ø¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­ÙØ¸
            stats_text = "âœ… **ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!**\n\n"
            stats_text += "ğŸ“Š **Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:**\n"
            
            if config.DATABASE_TYPE == "postgresql":
                stats_text += "â”œ ğŸ—„ï¸ **Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** PostgreSQL\n"
                stats_text += "â”œ ğŸ‘¥ **Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†:** Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n"
                stats_text += "â”œ âš™ï¸ **Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª:** Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹\n"
                stats_text += "â”œ ğŸ”’ **Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†:** Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹\n"
                stats_text += "â”” ğŸ“ˆ **Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:** Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹\n\n"
            else:
                stats_text += "â”œ ğŸ—„ï¸ **Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** MongoDB\n"
                stats_text += "â”œ ğŸ‘¥ **Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†:** Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„Ù‚Ø§Ø¹Ø¯Ø©\n"
                stats_text += "â”œ âš™ï¸ **Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª:** Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹\n"
                stats_text += "â”œ ğŸ”’ **Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†:** Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹\n"
                stats_text += "â”” ğŸ“ˆ **Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:** Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹\n\n"
            
            stats_text += "ğŸ’¡ **Ù…Ù„Ø§Ø­Ø¸Ø©:** Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø³ØªØ¨Ù‚Ù‰ Ù…Ø­ÙÙˆØ¸Ø© Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª."
            
            await status_msg.edit_text(stats_text)
        else:
            await status_msg.edit_text(
                "âŒ **Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª!**\n\n"
                "âš ï¸ **Ù‚Ø¯ ØªÙÙ‚Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„.**\n"
                "ğŸ”§ **ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.**"
            )
    
    except Exception as e:
        await status_msg.edit_text(
            f"âŒ **Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:**\n\n"
            f"```\n{str(e)}\n```\n\n"
            f"ğŸ”§ **ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.**"
        )
